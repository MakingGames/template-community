name: Auto-Retry Cloudflare Deploy

on:
  push:
    branches: [main]
    paths:
      - 'blog/posts/**'

env:
  # Configure per-repo: Set this as a repository variable
  SITE_URL: ${{ vars.SITE_URL }}
  NOTIFY_EMAIL: support@emberbright.studio

jobs:
  # First attempt - verify and retry if needed
  verify-deployment:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[auto-retry]')"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for Cloudflare deployment
        run: sleep 180

      - name: Verify deployment
        id: verify
        run: |
          LOCAL_FIRST_ID=$(cat blog/posts/posts.json | jq -r '.[0].id')
          echo "Expected: $LOCAL_FIRST_ID"

          LIVE_FIRST_ID=$(curl -s "$SITE_URL/blog/posts/posts.json" | jq -r '.[0].id')
          echo "Live: $LIVE_FIRST_ID"

          if [ "$LOCAL_FIRST_ID" = "$LIVE_FIRST_ID" ]; then
            echo "deployed=true" >> $GITHUB_OUTPUT
          else
            echo "deployed=false" >> $GITHUB_OUTPUT
          fi

      - name: Retry deployment
        if: steps.verify.outputs.deployed == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit --allow-empty -m "Retry Cloudflare deployment [auto-retry]"
          git push

  # Second attempt - verify and notify if still failed
  verify-retry:
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, '[auto-retry]')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for Cloudflare deployment
        run: sleep 180

      - name: Verify deployment
        id: verify
        run: |
          LOCAL_FIRST_ID=$(cat blog/posts/posts.json | jq -r '.[0].id')
          echo "Expected: $LOCAL_FIRST_ID"

          LIVE_FIRST_ID=$(curl -s "$SITE_URL/blog/posts/posts.json" | jq -r '.[0].id')
          echo "Live: $LIVE_FIRST_ID"

          if [ "$LOCAL_FIRST_ID" = "$LIVE_FIRST_ID" ]; then
            echo "deployed=true" >> $GITHUB_OUTPUT
            echo "✅ Retry succeeded!"
          else
            echo "deployed=false" >> $GITHUB_OUTPUT
            echo "❌ Retry also failed"
          fi

      - name: Send failure notification
        if: steps.verify.outputs.deployed == 'false'
        run: |
          curl -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer ${{ secrets.RESEND_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "from": "Forge Deploy <noreply@emberbright.studio>",
              "to": ["'"$NOTIFY_EMAIL"'"],
              "subject": "⚠️ Deployment failed: ${{ github.repository }}",
              "text": "Cloudflare deployment failed after automatic retry.\n\nRepository: ${{ github.repository }}\nSite: '"$SITE_URL"'\nCommit: ${{ github.sha }}\n\nPlease check the Cloudflare Pages dashboard and manually retry."
            }'
