name: Auto-Retry Cloudflare Deploy

on:
  push:
    branches: [main]
    paths:
      - 'blog/posts/**'

jobs:
  verify-deployment:
    runs-on: ubuntu-latest
    # Skip if this is already a retry commit
    if: "!contains(github.event.head_commit.message, '[auto-retry]')"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for Cloudflare deployment
        run: sleep 180

      - name: Verify deployment
        id: verify
        run: |
          LOCAL_FIRST_ID=$(cat blog/posts/posts.json | jq -r '.[0].id')
          echo "Expected: $LOCAL_FIRST_ID"

          LIVE_FIRST_ID=$(curl -s "https://groupigniter-demo.pages.dev/blog/posts/posts.json" | jq -r '.[0].id')
          echo "Live: $LIVE_FIRST_ID"

          if [ "$LOCAL_FIRST_ID" = "$LIVE_FIRST_ID" ]; then
            echo "deployed=true" >> $GITHUB_OUTPUT
          else
            echo "deployed=false" >> $GITHUB_OUTPUT
          fi

      - name: Retry deployment
        if: steps.verify.outputs.deployed == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit --allow-empty -m "Retry Cloudflare deployment [auto-retry]"
          git push
